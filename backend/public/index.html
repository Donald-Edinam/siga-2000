<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGA | Content Management</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#28a745', // Green
                            hover: '#218838',
                        },
                        warning: {
                            DEFAULT: '#ffc107', // Yellow
                            hover: '#e0a800',
                        },
                        danger: {
                            DEFAULT: '#dc3545', // Red
                            hover: '#c82333',
                        },
                        success: {
                            DEFAULT: '#28a745',
                        },
                        neutral: {
                            100: '#f8f9fa',
                            200: '#e9ecef',
                            300: '#dee2e6',
                            400: '#ced4da',
                            500: '#adb5bd',
                            600: '#6c757d',
                            700: '#495057',
                            800: '#343a40',
                            900: '#212529'
                        },
                    }
                }
            }
        }
    </script>

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff;
            /* White background */
        }

        /* Modal styles */
        .modal {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.active {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #adb5bd;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6c757d;
        }

        /* Line clamp utility */
        .line-clamp-1 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 1;
        }

        .line-clamp-2 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
        }

        .line-clamp-3 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 3;
        }

        /* Notification Toast */
        #notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            transform: translateX(120%);
            transition: transform 0.4s ease-in-out;
        }

        #notification-toast.show {
            transform: translateX(0);
        }
    </style>
</head>

<body class="bg-neutral-100 min-h-screen">

    <!-- Notification Toast -->
    <div id="notification-toast" class="p-4 rounded-lg shadow-lg text-white max-w-sm">
        <p id="notification-message"></p>
    </div>

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <header class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-neutral-800">Content Management</h1>
                    <p class="text-sm text-neutral-500 mt-1">SIGA Posts Administration Panel</p>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="openModal()"
                        class="bg-primary hover:bg-primary-hover text-white px-5 py-2.5 rounded-lg font-semibold text-sm shadow-sm transition-colors duration-200 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                                clip-rule="evenodd" />
                        </svg>
                        New Post
                    </button>
                    <a href="/logout" class="text-neutral-600 hover:text-neutral-800 text-sm font-semibold transition-colors duration-200">Logout</a>
                </div>
            </div>
        </header>

        <!-- Posts Grid -->
        <main id="postsContainer" class="grid gap-8 md:grid-cols-2 xl:grid-cols-3">
            <!-- Posts will be loaded here -->
        </main>

        <!-- Loading State -->
        <div id="loading" class="text-center py-16">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"></div>
            <p class="mt-4 text-neutral-600">Loading content...</p>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-20 bg-white rounded-xl shadow-sm hidden">
            <div class="text-neutral-400 text-6xl mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="1">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </div>
            <h2 class="text-xl font-semibold text-neutral-700 mb-2">No posts to display</h2>
            <p class="text-neutral-500 mb-6">Get started by creating your first post.</p>
            <button onclick="openModal()"
                class="bg-primary hover:bg-primary-hover text-white px-6 py-3 rounded-lg font-semibold shadow-sm transition-colors duration-200">
                Create First Post
            </button>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center z-50 p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <header class="p-6 border-b border-neutral-200 flex justify-between items-center">
                <h2 id="modalTitle" class="text-xl font-bold text-neutral-800">Add New Post</h2>
                <button onclick="closeModal()"
                    class="text-neutral-500 hover:text-neutral-800 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </header>

            <form id="postForm" enctype="multipart/form-data" class="p-6 overflow-y-auto custom-scrollbar flex-grow">
                <input type="hidden" id="postId" name="postId">

                <div class="mb-5">
                    <label for="announcement_header" class="block text-sm font-medium text-neutral-700 mb-2">
                        Announcement Header <span class="text-danger">*</span>
                    </label>
                    <input type="text" id="announcement_header" name="announcement_header" required
                        class="w-full p-3 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-shadow duration-200 shadow-sm">
                </div>

                <div class="mb-5">
                    <label for="description" class="block text-sm font-medium text-neutral-700 mb-2">
                        Description <span class="text-danger">*</span>
                    </label>
                    <textarea id="description" name="description" rows="5" required
                        class="w-full p-3 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-shadow duration-200 shadow-sm"></textarea>
                </div>

                <div class="mb-6">
                    <label for="image" class="block text-sm font-medium text-neutral-700 mb-2">
                        Featured Image
                    </label>
                    <div
                        class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-neutral-300 border-dashed rounded-md">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-neutral-400" stroke="currentColor" fill="none"
                                viewBox="0 0 48 48" aria-hidden="true">
                                <path
                                    d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="flex text-sm text-neutral-600">
                                <label for="image"
                                    class="relative cursor-pointer bg-white rounded-md font-medium text-primary hover:text-primary-hover focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary">
                                    <span>Upload a file</span>
                                    <input id="image" name="image" type="file" class="sr-only" accept="image/*">
                                </label>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p class="text-xs text-neutral-500">PNG, JPG, GIF, WebP up to 5MB</p>
                        </div>
                    </div>

                    <!-- Current image preview -->
                    <div id="currentImagePreview" class="mt-4 hidden">
                        <p class="text-sm font-medium text-neutral-700 mb-2">Current image:</p>
                        <div class="relative w-48 h-32">
                            <img id="currentImage" src="" alt="Current image"
                                class="w-full h-full object-cover rounded-lg shadow-md">
                        </div>
                    </div>
                </div>
            </form>
            
            <footer class="p-6 border-t border-neutral-200 bg-neutral-100/50 flex justify-end gap-4">
                <button type="button" onclick="closeModal()"
                    class="px-6 py-2.5 border border-neutral-300 rounded-lg text-sm font-semibold text-neutral-700 bg-white hover:bg-neutral-100 transition-colors duration-200">
                    Cancel
                </button>
                <button type="submit" form="postForm"
                    class="px-6 py-2.5 bg-primary hover:bg-primary-hover text-white rounded-lg text-sm font-semibold shadow-sm transition-colors duration-200 flex items-center justify-center min-w-[120px]">
                    <span id="submitText">Create Post</span>
                </button>
            </footer>
        </div>
    </div>

    <script>
        let posts = [];
        let editingPost = null;

        document.addEventListener('DOMContentLoaded', loadPosts);

        async function loadPosts() {
            setLoading(true);
            try {
                const response = await fetch('/api/posts');
                if (!response.ok) throw new Error('Network response was not ok');
                posts = await response.json();
                console.log('Loaded posts:', posts); // Debug log
                renderPosts();
            } catch (error) {
                console.error('Error loading posts:', error);
                showNotification('Failed to load posts. Please try again later.', 'danger');
            } finally {
                setLoading(false);
            }
        }

        function setLoading(isLoading) {
            document.getElementById('loading').style.display = isLoading ? 'block' : 'none';
            if (!isLoading) {
                checkEmptyState();
            } else {
                document.getElementById('postsContainer').style.display = 'none';
                document.getElementById('emptyState').classList.add('hidden');
            }
        }

        function checkEmptyState() {
            const container = document.getElementById('postsContainer');
            const emptyState = document.getElementById('emptyState');
            if (posts.length === 0) {
                container.style.display = 'none';
                emptyState.classList.remove('hidden');
            } else {
                container.style.display = 'grid';
                emptyState.classList.add('hidden');
            }
        }

        function renderPosts() {
            const container = document.getElementById('postsContainer');
            container.innerHTML = posts.map(post => {
                // Safely escape the post ID and other data
                const postId = post.id.toString();
                const safeHeader = post.announcement_header.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
                const safeDescription = post.description.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
                
                return `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden transition-shadow duration-300 hover:shadow-lg flex flex-col">
                        <div class="w-full h-48 ${post.featured_image ? '' : 'bg-neutral-200 flex items-center justify-center'}">
                            ${post.featured_image ?
                        `<img src="${post.featured_image}" alt="${safeHeader}" class="w-full h-full object-cover">` :
                        `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-neutral-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>`
                    }
                        </div>
                        <div class="p-5 flex-grow flex flex-col">
                            <h3 class="text-lg font-bold text-neutral-800 mb-2 line-clamp-2">${post.announcement_header}</h3>
                            <p class="text-neutral-600 text-sm mb-4 line-clamp-3 flex-grow">${post.description}</p>
                            <div class="text-xs text-neutral-400 mb-5 pt-4 border-t border-neutral-200">
                                Created: ${new Date(post.created).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
                            </div>
                            <div class="flex gap-3">
                                <button onclick="editPost('${postId}')" class="flex-1 bg-neutral-100 hover:bg-neutral-200 text-neutral-800 py-2 px-4 rounded-lg text-sm font-semibold transition-colors duration-200">
                                    Edit
                                </button>
                                <button onclick="deletePost('${postId}')" class="flex-1 bg-danger/10 hover:bg-danger/20 text-danger py-2 px-4 rounded-lg text-sm font-semibold transition-colors duration-200">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openModal() {
            editingPost = null;
            document.getElementById('modalTitle').textContent = 'Add New Post';
            document.getElementById('submitText').textContent = 'Create Post';
            document.getElementById('postForm').reset();
            document.getElementById('postId').value = '';
            document.getElementById('currentImagePreview').classList.add('hidden');
            document.getElementById('modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function editPost(id) {
            console.log('Edit post called with ID:', id); // Debug log
            const post = posts.find(p => p.id.toString() === id.toString());
            console.log('Found post:', post); // Debug log
            
            if (!post) {
                console.error('Post not found with ID:', id);
                showNotification('Post not found', 'danger');
                return;
            }

            editingPost = post;

            // Reset form and then populate it with the existing post data
            document.getElementById('postForm').reset();
            document.getElementById('modalTitle').textContent = 'Edit Post';
            document.getElementById('submitText').textContent = 'Update Post';
            document.getElementById('postId').value = post.id;
            document.getElementById('announcement_header').value = post.announcement_header;
            document.getElementById('description').value = post.description;

            const imagePreview = document.getElementById('currentImagePreview');
            if (post.featured_image) {
                document.getElementById('currentImage').src = post.featured_image;
                imagePreview.classList.remove('hidden');
            } else {
                imagePreview.classList.add('hidden');
            }

            // Show the modal
            document.getElementById('modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        async function deletePost(id) {
            if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) return;

            try {
                const response = await fetch(`/api/posts/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showNotification('Post deleted successfully', 'success');
                    loadPosts();
                } else {
                    const error = await response.json().catch(() => ({ error: 'Failed to delete post' }));
                    showNotification(error.error || 'Failed to delete post', 'danger');
                }
            } catch (error) {
                console.error('Error deleting post:', error);
                showNotification('An unexpected error occurred', 'danger');
            }
        }

        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitButton = document.querySelector('button[type="submit"][form="postForm"]');
            const originalSubmitText = submitButton.querySelector('span').textContent;
            submitButton.disabled = true;
            submitButton.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>`;

            const formData = new FormData(e.target);
            const isEditing = editingPost !== null;
            const url = isEditing ? `/api/posts/${editingPost.id}` : '/api/posts';
            const method = isEditing ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    body: formData
                });

                if (response.ok) {
                    showNotification(isEditing ? 'Post updated successfully' : 'Post created successfully', 'success');
                    closeModal();
                    loadPosts();
                } else {
                    const error = await response.json().catch(() => ({ error: 'Failed to save post' }));
                    showNotification(error.error || 'Failed to save post', 'danger');
                }
            } catch (error) {
                console.error('Error saving post:', error);
                showNotification('An unexpected error occurred', 'danger');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = `<span id="submitText">${originalSubmitText}</span>`;
            }
        });

        function showNotification(message, type = 'success') {
            const toast = document.getElementById('notification-toast');
            const messageP = document.getElementById('notification-message');

            messageP.textContent = message;

            // Reset classes
            toast.className = 'p-4 rounded-lg shadow-lg text-white max-w-sm';

            if (type === 'success') {
                toast.classList.add('bg-success');
            } else if (type === 'danger') {
                toast.classList.add('bg-danger');
            } else {
                toast.classList.add('bg-neutral-800');
            }

            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === "Escape" && document.getElementById('modal').classList.contains('active')) {
                closeModal();
            }
        });

        // Close modal when clicking outside the content
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('modal')) {
                closeModal();
            }
        });
    </script>
</body>

</html>